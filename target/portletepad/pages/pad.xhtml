<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:portlet="http://java.sun.com/portlet_2_0"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:a4j="http://richfaces.org/a4j"
	xmlns:rich="http://richfaces.org/rich">
<h:head>
	<h:outputStylesheet name="/css/my.css"/>
	<script type="text/javascript">
		$(document).ready(function() { prepareEditorContent() });
		userId = "#{sessionBean.session.user.id}";
		padId = "#{sessionBean.session.pad.id}";
		setReadOnly("#{padBean.pad.readOnly}");
		userColor = "#{sessionBean.session.colorCode}";
		var actColor = userColor;
		nextSpanId = "#{sessionBean.nextSliceSpanId}";
		var userToken = 0; // the variable will together with user id identify the actual state of user text preferences
		// - incrementing on every change of any preference affects the text
		// CHANGE TO ATTRIBUTE POOL MANGEMENT - only one to the continual attributes set
		
		function adjustColor(color) {
			$('#editor').find('span[class="cl'+actColor.substring(1)+'"]').toggleClass("cl"+actColor.substring(1)).toggleClass("cl"+color.substring(1));
			actColor = color;
		}

		function resetColor() {
			$('#editor').find('span[class="cl'+actColor.substring(1)+'"]').toggleClass("cl"+actColor.substring(1)).toggleClass("cl"+userColor.substring(1));
			actColor = userColor;
		}
	</script>
</h:head>

<h:body>
	<h:panelGroup class="padSitePanel" layout="block">
		<h:panelGroup rendered="#{userBean.actualUser != null}">
			<h:form id="pushForm">
				<a4j:push id="consumer" address="#{pushBean.topicAddress}" onerror="alert(event.rf.data)"
					ondataavailable="processMessage(event.rf.data); return false;">
					<a4j:ajax event="dataavailable" render="usersForm,footerFor,pushForm,pollForm" />
				</a4j:push>
			</h:form>
			<h:form id="pollForm">
				<a4j:poll enaled="#{sessionBean.pollEnabled}" interval="2000" render="usersForm,footerForm,pollForm" />
			</h:form>

			<h:form id="padBarLinksForm">
				<h:panelGroup layout="block" id="padBar">
					<a4j:commandLink styleClass="buttonLink right" value="leave" action="#{sessionBean.actionLeave}"/>
					<a4j:commandLink rendered="#{!padBean.pad.readOnly}" styleClass="buttonLink right" value="refresh" action="#{sessionBean.actionRefresh}"/>
				</h:panelGroup>
			</h:form>
			<h:form id="firstForm">
				<h:panelGroup layout="block" class="heading">
					<a4j:commandLink rendered="#{!padBean.pad.readOnly}" value="Pad: #{padBean.pad.name}" action="#{sessionBean.actionRefresh}" execute="@form"/>
					<h:outputText rendered="#{padBean.pad.readOnly}" value="Pad: #{padBean.pad.name} (ReadOnly mode)"/>
				</h:panelGroup>
			</h:form>

			<h:panelGrid columns="2" class="padInfoTab">
				<h:form id="userForm" rendered="#{!padBean.pad.readOnly}">
					<h:panelGrid id="padDesc" class="padInfo" columns="1"
						onmouseout="#{rich:element('chooseColorPanel')}.setAttribute('style','display:none'); resetColor();">
						<h:panelGrid columns="3" onmouseover="#{rich:element('chooseColorPanel')}.setAttribute('style','display:block');">
							<h:outputText class="label" value="User: " />
							<h:panelGroup>
								<h:panelGroup layout="block" class="colorSquare #{sessionBean.session.colorClass}" />
							</h:panelGroup>
							<h:outputText class="name" value="#{sessionBean.session.user.name} #{padsession.padCreator ? '(creator)' : ''}" />
						</h:panelGrid>
						<h:panelGrid id="chooseColorPanel" class="chooseColorPanel" style="display:none;" onmouseover="#{rich:element('chooseColorPanel')}.setAttribute('style','display:block');">
							<ui:repeat var="color" value="#{sessionBean.freeColors}">
								<h:commandLink action="#{sessionBean.changeColor(color)}" onmouseover="adjustColor('#{color}');">
									<h:panelGrid columns="2" class="colorItem">
										<h:panelGroup layout="block" class="colorSquare" style="background-color:#{color};" />
										<h:outputText class="colorName" value="#{color}" />
									</h:panelGrid>
								</h:commandLink>
							</ui:repeat>
						</h:panelGrid>
					</h:panelGrid>
				</h:form>
				<h:form id="usersForm" rendered="#{!padBean.pad.readOnly}">
					<h:panelGrid id="padUsers" class="padUsers" rendered="#{not empty sessionBean.activeSessions}" columns="1">
						<h:panelGroup class="topLabel"><h:outputText value="Joined users:" /></h:panelGroup>
						<h:dataTable columnClasses="color,name,creator,date" id="activePadUsersTable" class="activePadUsersTable"
							value="#{sessionBean.activeSessions}" var="padsession">
							<h:column>
								<h:panelGroup layout="block" class="colorSquare #{padsession.colorClass}" />
							</h:column>
							<h:column>
								<h:outputText value="#{padsession.user.name}" />
							</h:column>
							<h:column>
								<h:outputText value="#{padsession.padCreator ? '(creator)' : ''}" />
							</h:column>
						</h:dataTable>
					</h:panelGrid>
				</h:form>
			</h:panelGrid>

			<h:form id="changesetNotifierForm" rendered="#{!padBean.pad.readOnly}">
				<span id="anchorForChangeAction" />
				<a4j:commandButton style="display:none" id="resetNotificationButton" value="Process next change"
					action="#{sessionBean.processNext}" render="changesetNotifierForm" />
			</h:form>
			<h:form id="form">
				<div id="editor" tabindex="1">#{sessionBean.session.padAssembler.viewRepr}</div>
				<h:inputText rendered="#{!padBean.pad.readOnly}" style="display:none" id="changeset" value="#{sessionBean.changeset}" />
				<a4j:commandButton rendered="#{!padBean.pad.readOnly}" style="display:none" id="addChangesetButton"
					value="Submit changeset" action="#{sessionBean.addChangeset}"
					render="footerForm" status="padWorkStatus" />
			</h:form>
			<h:form id="footerForm">
				<h:panelGroup id="padFooterR" class="padFooterR">
					<a4j:status id="padWorkStatus" startText="Syncing..."
						stopText="Last modified: #{padBean.pad.shortModified} by #{padBean.pad.lastModifier.name}" />
				</h:panelGroup>
				<h:panelGroup class="padFooterL">
					<h:outputText value="Created: #{padBean.pad.shortCreated} by #{padBean.pad.creator.name}" />
				</h:panelGroup>
			</h:form>
		</h:panelGroup>
	</h:panelGroup>
</h:body>
</html>